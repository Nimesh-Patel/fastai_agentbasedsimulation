/*
 * Users who wish to extend FastSTI code are encouraged to modify this file and
 * fsti-userdefs.h.
 * It will not modified in FastSTI upgrades.
 *
 */

#include "fsti.h"

#include <gsl/gsl_rng.h>
#include <gsl/gsl_randist.h>
#include <math.h>


// Constants

#define MIN_AGE 1

static const double hivarray[] =
{0.0000041648,0.0000074823,0.0000092476,0.0000097784,0.0000085016,
 0.0000062430,0.0000055225,0.0000037158,0.0000015907,0.0000008385,
 0.0000005663,0.0000005952,0.0000001662,0.0000000000,0.0000000000};

static const double grimreaper[] =
{0.00000084559,0.00000125410,0.00000145151,0.00000192368,0.00000263100,
 0.00000413621,0.00000716194,0.00001263059,0.00002119956,0.00003329301,
 0.00004850874,0.00007472244,0.00011862434,0.00021368957,0.00076230839};

static const float no_contacts_eros[2][15] =
{
    { 4.476525, 5.282638, 6.742207, 8.343489,10.166510,
      10.974244,10.439324,10.354208, 8.254843, 7.203002,
      6.582314, 4.758008, 3.541667, 3.541667, 3.541667
    },
    { 9.298679, 9.674459,11.834843,14.129043,16.205440,
      16.978791,15.871613,15.721254,13.237936,11.850871,
      10.236755, 7.398405, 2.519130, 2.519130, 2.519130
    }
};

static const float sin_duration[2][15] = {
    {5.5563116,3.9484691,3.3424187,2.8199447,2.3331686,
     1.9092282,1.5624846,1.2787443,1.0465302,0.8564851,
     0.7009513,0.5736617,0.4694874,0.3842306,0.3401538
    },
    {1.283724,1.057034,1.128133,1.241670,1.349160,
     1.467092,1.599509,1.744011,1.901569,2.073360,
     2.260672,2.464905,2.687590,2.930392,3.085556
    }
};


static const double rel_duration[2][15][15] = {
    {
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            7.60949207222134,7.57811404096984,7.72266623233279,
            7.98119973517126,8.19612012518732,8.27120567934287,
            8.22649612630288,8.16071442878668,8.16071442878668,
            8.16071442878668,8.16071442878668,8.16071442878668,
            8.16071442878668,8.16071442878668,8.16071442878668
        },
        {
            7.45763896823751,7.72266627494429,8.12172058118853,
            8.54279288867796,8.77892366280795,8.7317637119894,
            8.48112225057944,8.27916583993796,8.27916583993796,
            8.27916583993796,8.27916583993796,8.27916583993796,
            8.27916583993796,8.27916583993796,8.27916583993796
        },
        {
            7.17518118781656,7.98119976757166,8.54279281669539,
            8.72383661762895,8.5647601797822,8.18442979702956,
            7.71605565749025,7.43871815454728,7.43871815454728,
            7.43871815454728,7.43871815454728,7.43871815454728,
            7.43871815454728,7.43871815454728,7.43871815454728
        },
        {
            6.94899046594238,8.19612011564585,8.77892347181551,
            8.56476002692895,7.96355139846431,7.32447632610641,
            6.76743409171578,6.4952002298299,6.4952002298299,
            6.4952002298299,6.4952002298299,6.4952002298299,
            6.4952002298299,6.4952002298299,6.4952002298299
        },
        {
            6.86400795706655,8.27120561813348,8.73176341859952,
            8.18442950059418,7.32447616195522,6.6061248082001,
            6.08915189919276,5.87262708397293,5.87262708397293,
            5.87262708397293,5.87262708397293,5.87262708397293,
            5.87262708397293,5.87262708397293,5.87262708397293
        },
        {
            6.89227669073437,8.22649601586873,8.48112188995775,
            7.71605525496032,6.76743378848281,6.0891517443511,
            5.67734878180497,5.53663856018843,5.53663856018843,
            5.53663856018843,5.53663856018843,5.53663856018843,
            5.53663856018843,5.53663856018843,5.53663856018843
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        },
        {
            6.94729915117173,8.16071429335175,8.2791654565963,
            7.43871770867783,6.49519986008161,5.87262684764412,
            5.53663847247158,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137,
            5.44376156748137,5.44376156748137,5.44376156748137
        }
    },
    {
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },

        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        },
        {
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097,
            1.44588936461097,1.44588936461097,1.44588936461097
        }
    }
};

static const float no_contacts_aphrodite[2][15] =
{
    {
        24.84061,26.94250,26.54519,24.98904,24.32991,
        23.13493,22.61359,22.03032,20.78864,21.92857,
        21.03906,17.16129, 9.87500, 9.87500, 9.87500
    },
    {
        18.68999,18.22958,17.92442,18.03134,18.22131,
        18.37347,18.52438,18.37625,18.08848,18.91203,
        18.81903,17.84582,13.97244,13.97244,13.97244
    }
};


// Each agent has a birthday between 1 and 1825 (because I use 5-year age groups)
// This way not all agents age on the same day.
// CO-INFECTION WITH HIV IS AGE DEPENDENT AND CO-MODELLED WITH AGING
void event_age(struct fsti_simulation *simulation)
{
    struct fsti_agent *a;
    FSTI_FOR_LIVING(*simulation, a, {
            if ( (simulation->iteration - a->birthday) % 1825 == 0) {
                a->age_group++;
                // HIV AS COMORBIDITY
                if (a->hiv == 0)
                    if (hivarray[a->age_group - 1] <
                        gsl_rng_uniform(simulation->rng))
                        a->hiv = 1;
            }
        });
}



// Function for mortality of agents;
// I AM UNSURE IF FSTI_AGENT_REMOVE IS THE CORRECT FUNCTION FOR THIS
// ALSO THE PARTNER WOULD NEED TO BE INFORMED THAT HIS S.O. HAS DIED
// Nathan's response: The simulation_kill_agent function sorts it out.
void event_hades(struct fsti_simulation *simulation)
{
    struct fsti_agent *a;
    size_t *it;
    unsigned age_group;

    it = simulation->living.indices;
    while (it < (simulation->living.indices + simulation->living.len)) {
        a = fsti_agent_ind_arrp(&simulation->living, it);
        age_group = a->age_group;
        if (gsl_rng_uniform(simulation->rng) < grimreaper[age_group - MIN_AGE]) {
            fsti_simulation_kill_agent(simulation, it);
        } else {
            ++it;
        }
    }
}

// Enter mating pool for singles for short-time hook-ups
void event_eros(struct fsti_simulation *simulation)
{
  struct fsti_agent *a;
  double sexint;
  unsigned age_group;

  fsti_agent_ind_clear(&simulation->mating_pool);
  FSTI_FOR_LIVING(*simulation, a, {
          if (a->num_partners == 0) {
              age_group = a->age_group;
              sexint = (gsl_ran_gaussian(simulation->rng, 1) * a->re_sexact *
                        no_contacts_eros[1][age_group - MIN_AGE] +
                        no_contacts_eros[0][age_group - MIN_AGE]) / 365;
              if (gsl_rng_uniform(simulation->rng) < sexint)
                  fsti_agent_ind_push(&simulation->mating_pool, a->id);
          }
      });
}

static void set_relstat(struct fsti_agent *agent, size_t iteration,
                        gsl_rng *rng)
{
    unsigned age_group;
    double a, b;

    age_group = agent->age_group;

    a = sin_duration[0][age_group - MIN_AGE];
    b = sin_duration[1][age_group - MIN_AGE];
    agent->relstat = iteration + gsl_ran_weibull(rng, a, b) * 365;
}

// Determine time of agent being single
void event_dionysus(struct fsti_simulation *simulation)
{
    struct fsti_agent *a, *b;

    FSTI_FOR_LIVING(*simulation, a, {
            // If agent is in partnership and duration of partnership has run out
            b = fsti_agent_partner_get0(&simulation->agent_arr, a);
            if (b && simulation->iteration > a->relstat) {
                fsti_agent_break_partners(a, b);
                // Determine at what day in the future these agents will start
                // looking for new partners

                set_relstat(a, simulation->iteration, simulation->rng);
                set_relstat(b, simulation->iteration, simulation->rng);
            }
        });
}

// Model sexual contacts within relationships
void event_aphrodite(struct fsti_simulation *simulation)
{
    struct fsti_agent *a, *b;
    double sexint, r;
    unsigned age_group;

  FSTI_FOR_LIVING(*simulation, a, {
          b = fsti_agent_partner_get0(&simulation->agent_arr, a);
          if (b && b->infected == true && a->infected == false) {
              age_group = a->age_group;
              r = gsl_ran_gaussian(simulation->rng, 1);
              sexint = (r * a->re_sexact *
                        no_contacts_aphrodite[1][age_group - MIN_AGE] +
                        no_contacts_aphrodite[0][age_group - MIN_AGE]) / 365.0;
              if (gsl_rng_uniform(simulation->rng) < sexint)
                  a->infected = true;
          }
      });
}

// Determine duration of relationship
// Implemented as a hook, that is executed after matching
void hestia(struct fsti_simulation *simulation,
            struct fsti_agent *a, struct fsti_agent *b)
{
    a->reldur = gsl_ran_weibull(simulation->rng,
                                rel_duration[0]
                                [a->age_group-MIN_AGE]
                                [b->age_group-MIN_AGE],
                                rel_duration[1]
                                [a->age_group-MIN_AGE]
                                [b->age_group-MIN_AGE]) * 365;
    b->reldur = a->reldur;
}
