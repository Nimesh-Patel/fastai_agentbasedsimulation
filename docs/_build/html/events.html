

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Events &mdash; FastSTI 0.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Extending FastSTI" href="extending.html" />
    <link rel="prev" title="Configuration file parameters" href="parameters.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> FastSTI
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getstart.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="inputformats.html">Input file formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="outputformats.html">Output file formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameters.html">Configuration file parameters</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Events</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#read-agents">_read_agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generate-agents">_generate_agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#age">_age</a></li>
<li class="toctree-l2"><a class="reference internal" href="#death">_death</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initial-mating">_initial_mating</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initial-rel">_initial_rel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mating-pool">_mating_pool</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending FastSTI</a></li>
<li class="toctree-l1"><a class="reference internal" href="improve.html">Help improve FastSTI</a></li>
<li class="toctree-l1"><a class="reference internal" href="improve.html#bugs-and-other-issues">Bugs and other issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="credits.html">Credits</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">FastSTI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Events</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/events.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="events">
<span id="event-ref"></span><h1>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h1>
<p>The events to run for a simulation are specified in these parameters:
- before_events,
- during_events, and
-  after_events.</p>
<p>These, respectively, are the events run once at the start of each simulation
(before_events), on every iteration of the simulation (during_events), and once
at the end of the simulation (after_events).</p>
<p>Here is a way to specify a comprehensive simulation:</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="na">before_events</span> <span class="o">=</span> <span class="s">_write_agents_csv_header; _write_results_csv_header; _generate_and_pair; _write_agents_csv; _report</span>

 <span class="na">during_events</span> <span class="o">=</span> <span class="s">_age; _breakup_and_pair; _infect; _stage; _birth; _death; _report</span>

 <span class="na">after_events</span> <span class="o">=</span> <span class="s">_write_agents_csv</span>
</pre></div>
</td></tr></table></div>
<p>This tells FastSTI that before each simulation is run, it must:</p>
<ul class="simple">
<li>Write the header line for the output agents csv file
(_write_agents_csv_header)</li>
<li>Write the header line for the output results file (_write_results_csv_header)</li>
<li>Generate and initialize properly a new set of agents and put some of them into
relationships (_generate_and_pair)</li>
<li>Write the set of initialised agents to a CSV file.</li>
<li>Write some stats (e.g. prevalence, agents alive, agents dead etc) to the
results file (_report).</li>
</ul>
<p>On every time step of a simulation, it tells FastSTI to:</p>
<ul class="simple">
<li>Increment each living agent’s by the time step (_age).</li>
<li>Iterate through the living agents and put some of the single ones into
relationships and break up some of those that are in relationships
(_breakup_and_pair).</li>
<li>Iterate through the agents with partners and infect some of those in
sero-discordant relationships (_infect).</li>
<li>Iterate through the infected agents and move some of them to a new disease
stage (e.g. treated, resistant, ill - whatever you specify actually).</li>
<li>Add some new agents to the simulation at the minimum age (_birth).</li>
<li>Kill some of the agents (_death).</li>
<li>Write some stats (e.g. prevalence, agents alive, agents dead etc) to the
results file (_report).</li>
</ul>
<p>At the end of each simulation it tells FastSTI to:</p>
<ul class="simple">
<li>Write the final state of the agents to a CSV file (_write_agents_csv).</li>
</ul>
<p>The events provided by FastSTI (which include those in the example above) are
prefixed with an underscore (_), to differentiate them from other 3rd-party
events or ones that you choose to implement. Please don’t name your events with
a leading underscore.</p>
<p>If the events provided by FastSTI are not all you need, then you are encouraged
to code your own events in C in the source code files fsti-userdefs.h and
fsti-userdefs.c.</p>
<div class="section" id="read-agents">
<h2>_read_agents<a class="headerlink" href="#read-agents" title="Permalink to this headline">¶</a></h2>
<p>Reads in a csv file of agents at the beginning of a simulation. The first
time it is executed, it saves the agents in memory so that on subsequent
simulations, it doesn’t have to process the file again.</p>
<p>If you don’t have a file of agents to read in, consider using the
_generate_agents event.</p>
<p>Datasets: None</p>
</div>
<div class="section" id="generate-agents">
<h2>_generate_agents<a class="headerlink" href="#generate-agents" title="Permalink to this headline">¶</a></h2>
<p>Generates agents for a simulation instead of reading them from a file.</p>
<p>It uses the num_agents parameter to determine the number of agents to
generate.</p>
<p>The default implementation sets the following agent properties: age, sex,
sex_preferred, infected, treated and resistant.</p>
<ul class="simple">
<li>age is set via a random beta distribution determined by the parameters
age_alpha and age_beta.</li>
<li>sex is set via the dataset dataset_gen_sex. (See data/dataset_gen_sex.csv
for an example.)</li>
<li>sex_preferred is set via the dataset dataset_gen_sex_preferred. (See
data/dataset_gen_sex_preferred.csv for an example, which sets the agents to
prefer the opposite sex with a probability of 95%, but you can change this
according to the needs of your model.)</li>
<li>infected (i.e. the infection stage of the agent with 0 by convention meaning
the agent isn’t infected) is set via the dataset dataset_gen_infect. (See
data/dataset_gen_infect.csv for an example.)</li>
<li>treated (i.e. which treatment line, if any, the agent is on) is set via the
dataset dataset_gen_treated. (See data/dataset_gen_treated.csv for an
example.)</li>
<li>resistant (i.e. which treatment regimens the agent is resistant to, if
any. (See data/dataset_gen_resistant.csv for an example.)</li>
</ul>
<p>If you wish to set additional agent properties, you must provide hook in by
defining a macro called FSTI_HOOK_GENERATE_AGENT in fsti-userdefs.h. The macro
takes two parameters: simulation (a pointer to the current simulation) and
agent (a pointer to the current agent whose property you wish to set).</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Instead of using this event, it will usually make more sense to use the
_generate_and_pair event which generates the initial set of agents,
places them in a mating pool, shuffles the mating pool, mates the
agents in the mating pool and then sets the number of time steps each
agent will stay in its current relationship or stay single. This event
is in fact called by _generate_and_pair.</p>
</div>
<p>See also: <em>_generate_and_pair</em></p>
</div>
<div class="section" id="age">
<h2>_age<a class="headerlink" href="#age" title="Permalink to this headline">¶</a></h2>
<p>Iterates through all the living agents, and adds the time increment of the
simulation to their age.</p>
<p>This is one of the simplest events provided by FastSTI, and so it makes a nice
example of how events are implemented. Here is the source code:</p>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>   <span class="kt">void</span>
   <span class="nf">fsti_event_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsti_simulation</span> <span class="o">*</span><span class="n">simulation</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">struct</span> <span class="n">fsti_agent</span> <span class="o">*</span><span class="n">agent</span><span class="p">;</span>
      <span class="n">FSTI_FOR_LIVING</span><span class="p">(</span><span class="o">*</span><span class="n">simulation</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="p">{</span>
         <span class="n">agent</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">+=</span> <span class="n">simulation</span><span class="o">-&gt;</span><span class="n">time_step</span><span class="p">;</span>
      <span class="p">});</span>
   <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>All events are declared like this, i.e. a void function that takes one
parameter: a pointer to the simulation itself.</p>
<p>On line 4 we declare a pointer to an agent on line three. When we iterate
through the living agents, this will be a pointer to the current agent the
code acts upon.</p>
<p>The FSTI_FOR_LIVING macro implements a for loop over the living agents.
The code inside the macro’s curly brackets simply adds the time step to each
agent’s age.</p>
<p>Datasets: None</p>
</div>
<div class="section" id="death">
<h2>_death<a class="headerlink" href="#death" title="Permalink to this headline">¶</a></h2>
<p>Iterates through the living agents and kills some of them.</p>
<p>Datasets: dataset_mortality</p>
<p>Here is a simple example of this dataset:</p>
<div class="highlight-none notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>     infected;0
     0;0.00000296
     1;0.00000315
     2;0.00000315
     3;0.00000630
     4;0.001
</pre></div>
</td></tr></table></div>
<p>The first column tells the event to determine the infection stage of the
agent. The second column is the probability of the agent dying on this time
step. Here the probabilities are specified per day. If you change the time
step to, say, a week you have to update the probabilities in this file
accordingly.</p>
</div>
<div class="section" id="initial-mating">
<h2>_initial_mating<a class="headerlink" href="#initial-mating" title="Permalink to this headline">¶</a></h2>
<p>Before a simulation starts but after agents have been generated or read in
from a file, it is possible that none of the agents are in sexual
relationships.</p>
<p>This event is responsible for creating the initial mating pool of agent sexual
relationships. It is typically only run once per simulation, and only if the
agent input file doesn’t specify relationships. It is set as an event to run
in the before_events parameter.</p>
<p>Note that it doesn’t actually put the agents into relationships, only into a
mating pool. An agent pairing event, such as _rkpm must then be executed in
order to actually place agents in relationships with each other.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Instead of using this event, it will usually make more sense to use the
_generate_and_pair event which generates the initial set of agents,
places them in a mating pool, shuffles the mating pool, mates the
agents in the mating pool and then sets the number of time steps each
agent will stay in its current relationship or stay single. This event
is in fact called by _generate_and_pair.</p>
</div>
<p>Datasets: dataset_gen_mating</p>
<p>Here is an example of this dataset. The first column is age in five-year
periods. So for example line 5 corresponds to the probability of a person aged
15 to just shy of 20 being in a relationship (which in this example is 0.3 or
30%).</p>
<div class="highlight-none notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  age|5-YEAR;0
  0;0.0
  1;0.0
  2;0.0
  3;0.3
  4;0.35
  5;0.4
  6;0.45
  7;0.5
  8;0.5
  9;0.5
  10;0.5
  11;0.5
  12;0.4
  13;0.4
  14;0.35
  15;0.3
  16;0.25
  17;0.2
  18;0.15
  19;0.1
  20;0.5
  21;0
</pre></div>
</td></tr></table></div>
<p>See also: <em>_generate_and_pair</em></p>
</div>
<div class="section" id="initial-rel">
<h2>_initial_rel<a class="headerlink" href="#initial-rel" title="Permalink to this headline">¶</a></h2>
<p>For each living agent make a correction to the duration (number of time steps)
its current relationship, or if the agent is single, set the period it will stay
single.</p>
<p>This event assumes the relchange (the date/time in the future at which it’s
current relationship or single status changes) property of agents in
relationships has been set. It multiplies it by a uniform random number between
0 and 1. If the agent is single it sets the single period and also multiples it
by a uniform random number between 0 and 1.</p>
<p>Why use this event? Because the simulation starts at an arbitrary time point in
which people are already in the middle of relationships or a period of being
being single. This event will on average halve the value of relchange. Whether
that’s a valid assumption at the beginning of a simulation is unclear to us.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Instead of using this event, it will usually make more sense to use the
_generate_and_pair event which generates the initial set of agents,
places them in a mating pool, shuffles the mating pool, mates the
agents in the mating pool and then sets the number of time steps each
agent will stay in its current relationship or stay single. This event
is in fact called by _generate_and_pair.</p>
</div>
<p>Datasets: None</p>
<p>See also: <em>_generate_and_pair</em>, <em>_breakup</em> and <em>_rkpm</em>. The latter two also set
the relchange property.</p>
</div>
<div class="section" id="mating-pool">
<h2>_mating_pool<a class="headerlink" href="#mating-pool" title="Permalink to this headline">¶</a></h2>
<p>Iterates through the living agents and places the single ones into the mating
pool if they are due for a relationship status change. The relchange property of
each single agent determines whether it is to be placed in the mating pool.</p>
<p>Note that placing agents in the mating pool is necessary but not sufficient to
pair them into relationships. This event is typically followed by shuffling the
mating pool (_shuffle_mating) and then placing them in sexual relationships with
other agents in the mating pool using the pairing algorithm (_rkpm).</p>
<p>All of these events are included in the composite event _breakup_and_pair.</p>
<p>The C code for this event is simple and instructive:</p>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>   <span class="kt">void</span>
   <span class="nf">fsti_event_mating_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsti_simulation</span> <span class="o">*</span><span class="n">simulation</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">struct</span> <span class="n">fsti_agent</span> <span class="o">*</span><span class="n">agent</span><span class="p">;</span>
       <span class="n">fsti_agent_ind_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation</span><span class="o">-&gt;</span><span class="n">mating_pool</span><span class="p">);</span>
       <span class="n">FSTI_FOR_LIVING</span><span class="p">(</span><span class="o">*</span><span class="n">simulation</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">num_partners</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">relchange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">simulation</span><span class="o">-&gt;</span><span class="n">iteration</span><span class="p">)</span>
                   <span class="n">fsti_agent_ind_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation</span><span class="o">-&gt;</span><span class="n">mating_pool</span><span class="p">,</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
          <span class="p">}</span>
       <span class="p">});</span>
   <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>All events are declared like this, i.e. a void function that takes one parameter: a pointer to the simulation itself.</p>
<p>On line 4 we declare a pointer to an agent on line three. When we iterate through the living agents, this will be a pointer to the current agent the code acts upon.</p>
<p>The FSTI_FOR_LIVING macro implements a for loop over the living agents.</p>
<p>The code inside the macro’s curly brackets first checks that the agent is single
(i.e. it has zero partners). If it is it checks if the relchange property is
less than the current iteration. If it is, it places the agent in the mating
pool.</p>
<p>You may have noticed that agent-&gt;relchange on line 8 is subscripted with a 0
index. This is because FastSTI’s data structures support agents having multiple
concurrent partners. relchange[0] refers to the status of the first partner. By
default, up to three partners are supported and this is determined by
FSTI_MAX_PARTNERS set in fsti-defaults.h. To override this value, either with a
bigger or smaller maximum number of partners, simply define an alternative value
for FSTI_MAX_PARTNERS in fsti-userdefs.h. For example:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FSTI_MAX_PARTNERS 1</span>
</pre></div>
</div>
<p>But although the FastSTI data structures support concurrent partnerships, all of
the default events, including this one, do not support agents having more than
one partner. This may and probably should change in the future. Of course you
are also welcome to implement your own events that do account for concurrent
partnerships.</p>
<p>Datasets: None</p>
<p>See also: <em>_breakup_and_pair</em>.</p>
<p>TO DO FROM HERE</p>
<p>_breakup</p>
<p>_shuffle_living</p>
<p>_shuffle_mating</p>
<p>_rkpm</p>
<p>_breakup_and_pair</p>
<p>_generate_and_pair</p>
<p>_infect</p>
<p>_stage</p>
<p>_coinfect</p>
<p>_birth</p>
<p>_report</p>
<p>_write_results_csv_header,</p>
<p>_write_agents_csv_header</p>
<p>_write_partnerships_csv_header</p>
<p>_write_agents_csv</p>
<p>_write_living_agents_csv</p>
<p>_write_dead_agents_csv</p>
<p>_write_agents_pretty</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="extending.html" class="btn btn-neutral float-right" title="Extending FastSTI" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="parameters.html" class="btn btn-neutral float-left" title="Configuration file parameters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Nathan Geffen and Stefan Scholz

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>