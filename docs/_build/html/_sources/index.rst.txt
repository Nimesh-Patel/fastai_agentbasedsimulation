=======================================================
FastSTI: Simulations of sexually transmitted infections
=======================================================

############
Introduction
############

FastSTI is a framework for agent-based models of large simulations of sexually
transmitted infection epidemics. It is designed to handle up to tens of millions of
agents on standard consumer hardware, like your laptop or, or a high performance
computer.

It runs simulations in parallel. The output of the simulations is written to CSV
files, which can be further processed in scripting languages like Python
or R.

You can do sophisticated simulations without making any modifications to the
code. But if you do wish to extend the framework, it is written in C. The
framework has been designed with extensibility in mind. The code adheres
strictly to the C11 standard and should compile on any good modern C compiler.

############
Installation
############

*********
GNU/Linux
*********

Carry out these steps to install FastSTI on a GNU/Linux PC that uses apt
(e.g. Ubuntu).

Install the dependencies: ::

  sudo apt install git build-essential meson valgrind libgsl-dev libglib2.0-dev

Installing the framework is quick and easy.

Create a folder for the installation and cd into it. E.g. ::

  mkdir mysim; cd mysim
  git clone https://github.com/nathangeffen/faststi .

Installations are cheap and easy. Install as often as you like and, if an
installation is no longer needed, simply remove its folder with "rm -f".

***********
Apple macOS
***********

Compiling on macOS is easy. You can use either Apples clang/LLVM compiler or the
GNU C compiler.

Install and configure the dependencies with `Homebrew <https://brew.sh/>`_: ::

* (If you don't have Homebrew installed): ::

    /usr/bin/ruby -e "$(curl -fsSL  https://raw.githubusercontent.com/Homebrew/install/master/install)"
    brew install gcc pkg-config glib gsl meson ninja

- Create a folder for the installation and cd into it. E.g. ::

    mkdir mysim; cd mysim
    git clone https://github.com/nathangeffen/faststi .

Installations are cheap and easy. Install as often as you like and, if an
installation is no longer needed, simply remove its folder with "rm -f".



*******
Windows
*******

We haven't developed or tested FastSTI on Windows, but it should work,
especially if you use the MinGW suite. Feedback (via the `Github repository <https://github.com/faststi>`_) on
running it under Windows is welcome.


#####################
Testing that it works
#####################

If you use gcc as your C compiler, then simply do this: ::

  meson debug
  cd debug; ninja
  FSTI_DATA=../data ./src/faststi -t

This will run the test suite. If everything is properly installed no failures
should be reported.

You've created an unoptimised version of the faststi executable, useful for
debugging and development. To create an optimised version for running big,
CPU-intensive simulations, do this from the root directory of your simulation
(*mysim* in the above example): ::

  meson --buildtype release release

To test that it's working: ::

  cd release
  FSTI_DATA=../data ./src/faststi -t

Alternately you can use the *fsti* script in your installation directory. Assuming
you called it *mysim*, change into the *mysim* directory, and run: ::

  ./fsti -t

The above will create the debug directory, compile FastSTI, and run the test
suite. To instead run the release version: ::

  ./fsti release -t

Again, no errors should be reported.

If you have `valgrind <https://valgrind.org>`_ on your system (an excellent tool
for finding memory and other problems in C programs), you can do this: ::

  cd debug
  ninja test

##################
How to use FastSTI
##################

FastSTI takes as input a configuration file which tells it how many simulations
to run, and how to run each simulation. It also takes data as input in files
that we call datasets. And optionally, it takes a file of agents, though the
agents can be generated by FastSTI itself, via instructions in the configuration file.

The outputs are a report of simulation results, and the agents.


.. figure:: images/FastSTI-Overview.png
    :width: 280px
    :align: center
    :alt: Structure of FastSTI execution

    FastSTI inputs include a configuration file, datasets and agent files. The
    outputs are an agent file and simulation results.


***********
Simulations
***********

A simulation continuously iterates over sets of agents, executing events on the
agents on each iteration (which we call a time step). The structure of a FastSTI
simulation is: ::

  Execute events before simulation runs
  for each time-step
    for each event E
        for each agent A
            if E should be applied to A
                apply E to A
  Execute events after simulation runs

The number of agents and the specific events to execute are specified in a
configuration file. FastSTI's configuration file uses the *.ini* format, which
are the standard simple configuration format used on MS Windows and the GTK
framework popular on Linux systems.

You can configure the number of agents, the events and the order of events that
execute upon them, the size of the time step (default 1 day), the number of time
steps (default 10 years) and much else (see :ref:`parameter-ref`).

FastSTI has a number of useful built-in events useful for modelling STI
epidemics (see :ref:`event-ref`). These include agent ageing, death, matching
agents in sexual relationships, infection with the STI, disease advance,
co-infection, and breakups.

There are also useful supporting events that read in agent files or generate the
agents, write the agents to a CSV file, and write basic statistics to a CSV file.

If you need more events, the framework has been designed with extensibility in
mind. You can define new events in C, identify them to FastSTI, quickly
recompile the code and use them.

*******
Example
*******

Let's start off with the simplest simulation. Change into the
simulations/examples directory. Take a look at eg1.ini. ::

  # Faststi "Hello world" equivalent simulation
  [Simulation_0]
  after_events=_report

The first line is a comment.

The second line is the name of the simulation group: *First simulation*. A
simulation group can have one or more simulations. This particular group has
only one simulation.

The third line is one of the dozens of parameters used to configure
simulations. The *after_events* parameter tells FastSTI what events to execute
when the simulation is finished. *_report* is a built-in event that prints out
basic information about the state of a simulation. All built-in events are
prefixed with an underscore, to differentiate them from ones you might code
yourself.

To run the simulation: ::

  ../../fsti -f eg1.ini

The output may look something like this: ::

  First simulation;0;0;2028-01-01;MIN_AGE_ALIVE;nan
  First simulation;0;0;2028-01-01;MAX_AGE_ALIVE;nan
  First simulation;0;0;2028-01-01;MEAN_AGE_ALIVE;nan
  First simulation;0;0;2028-01-01;MEDIAN_AGE_ALIVE;nan
  First simulation;0;0;2028-01-01;INFECT_RATE_ALIVE;-nan
  First simulation;0;0;2028-01-01;POP_ALIVE;0
  First simulation;0;0;2028-01-01;NUM_PARTNERS;0
  First simulation;0;0;2028-01-01;MIN_AGE_DEAD;nan
  First simulation;0;0;2028-01-01;MAX_AGE_DEAD;nan
  First simulation;0;0;2028-01-01;MEAN_AGE_DEAD;nan
  First simulation;0;0;2028-01-01;INFECT_RATE_DEAD;-nan
  First simulation;0;0;2028-01-01;POP_DEAD;0
  First simulation;0;0;2028-01-01;INITIAL_INFECTIONS;0
  First simulation;0;0;2028-01-01;SIMULATION_INFECTIONS;0
  First simulation;0;0;2028-01-01;INITIAL_MATCHES;0
  First simulation;0;0;2028-01-01;SIMULATION_MATCHES;0
  First simulation;0;0;2028-01-01;BREAKUPS;0
  First simulation;0;0;2028-01-01;TIME_TAKEN;0

Note that it's in csv format, so you easily import it into Python or R and
process it. You can also redirect the output to a file instead of standard
output with the *results_file* parameter.

The fields of the csv file are: the name of the simulation, the number of the
current simulation, the number of the simulation within the current simulation
group, the date within the simulation for which the output applies, a
description field, and the value of the description field. E.g. the last two
columns of the last line are TIME_TAKEN and 0. This tells you that it took zero
seconds for the simulation to run. Likewise the POP_ALIVE and POP_DEAD entries
tell us that the population alive and dead in this simulation on 1 January 2028
is 0.

A full simulation
~~~~~~~~~~~~~~~~~

The output of the eg1.ini simulation is rather uninteresting. To get more
interesting output we need a more interesting simulation. Take a look at
eg2.ini. ::

     1	  # First interesting simulation
     2
     3	  [Full simulation]
     4
     5	  num_simulations=4
     6	  num_agents=10000
     7	  time_step=1 DAY
     8	  simulation_period_steps=10 YEARS
     9
     10	  before_events=_write_agents_csv_header;_generate_and_pair;_report;_write_agents_csv
     11	  during_events=_age;_breakup_and_pair;_infect;_stage;_birth;_death
     12	  after_events=_write_agents_csv;_report
     13
     14	  dataset_gen_sex=dataset_gen_sex.csv
     15	  dataset_gen_sex_preferred=dataset_gen_sex_preferred.csv
     16	  dataset_gen_infect=dataset_gen_infect.csv
     17	  dataset_gen_treated=dataset_gen_treated.csv
     18	  dataset_gen_resistant=dataset_gen_resistant.csv
     19	  dataset_gen_mating=dataset_gen_mating.csv
     20
     21	  dataset_birth_infect=dataset_gen_infect.csv
     22	  dataset_birth_treated=dataset_birth_treated.csv
     23	  dataset_birth_resistant=dataset_birth_resistant.csv
     24
     25	  dataset_rel_period=dataset_rel.csv
     26	  dataset_single_period=dataset_single.csv
     27	  dataset_infect=dataset_infect.csv
     28	  dataset_infect_stage=dataset_infect_stage.csv
     29	  dataset_mortality=dataset_mortality_simple.csv
     30
     31
     32	  agents_output_file=agents_out.csv
     33	  results_file=results.csv
     34
     35	  threads=1
     36
     37	  [Change time period]
     38
     39	  threads=0 # As many threads as there are cores will execute
     40	  simulation_period=5 YEARS

Assuming you are in the simulations/examples directory you can run this
simulation as follows: ::

  ../../fsti release -f eg2.ini

The *release* command line parameter ensures the much faster *release* version
of FastSTI (without debugging code) executes. It will likely take about 10
seconds to run.

This is what the configuration does:

- Line 1 is a comment. Comments start with a #.
- Line 3 specifies the name of the first group of simulations: *Full simulation*
- Line 5 specifies the number of simulations to run in this group. Note that
  parameter names, like *num_simulations*, are case-sensitive.
- Line 6 specifies the number of agents in the simulation.
- Line 7 specifies the time period represented by each simulation iteration, 1
  day in this case. The format for this parameter and others like it that
  specify a time period is a positive integer followed by either MINUTE, HOUR,
  DAY, WEEK, MONTH or YEAR. You can also use the plural of any of these time
  periods or any combination of lower and upper case (i.e. minute, minutes,
  hour, hours, day, days, week, weeks, month, months or year, years). You can
  also put a hyphen instead of a space between the integer and the time
  period. If you leave out the time period, it's assumed to be minutes. In
  FastSTI, the predefined time period have the following number of minutes:

  - hour: 60
  - day: 1440
  - week: 10,080
  - month: 43,830
  - year: 525949

- Line 8 specifies the simulation period: 10 years in this case. The number of
  time steps (or iterations) of the simulation is calculated by dividing the
  simulation_period by the time_step. In this simulation there are therefore
  3,652 iterations: :math:`10 \times 525949 / 1440`.
- Line 10 lists the events that are to be run before each simulation
  starts.

  - The _write_agents_csv_header event simply writes the first line of the csv
    file to which agents will be written.
  - The _generate_and_pair event generates agents (equal to the *num_agents*
    parameter) and pairs a subset of them in sexual relationships.
  - The _report event prints out some simple statistics about the agent
    population.
  - The _write_agents_csv event prints out the agents in csv format.

- Line 11 lists the events that are run on every iteration of the simulation.

  - The _age event increases the age of each agent by the *time_step* of the
    simulation (one day in this example).
  - The _breakup_and_pair event pairs a subset of agents into sexual
    partnerships and breaks up another subset of agents who are already in
    sexual partnerships.
  - The _infect event infects a subset of agents in sexual partnerships with
    other infected agents with the pathogen being studied, e.g. HIV.
  - The _stage event manages the infection progression of infected agents. For
    example, agents with HIV will first be in an acute sero-conversion phase,
    than a chronic infection stage, and then one or more stages that are
    analogous to progression to AIDS.
  - The _birth and _death events create new agents and kill agents respectively.

  Many of these events depend on pre-specified parameters to calculate
  probabilities of the events occurring and, perhaps, other outcomes. These data
  are described in dataset files which are described in the
  :ref:`dataset-format` section.

- Lines 14 to 29 list the names of the datasets associated with the various
  events. For example the *dataset_mortality* parameter tells the simulation the
  probability of an agent with a given set of characteristics dying.
- Line 32 tells the simulation to write agents out to a csv file called
  *agents_out.csv*.
- Line 33 tells the simulation to write simple population level statistical
  information produced by the *_report* event to a file called *results.csv*.
- Line 35 tells the simulation to run as a single thread. In other words each of
  the four simulations (specified on line 5) will run consecutively.
- Line 37 specifies a new simulation group called *Change time period*.
- Line 39 tells FastSTI to run the simulations in parallel, using up to as many
  threads as there are CPU cores in the machine. On a quad-core CPU, all four
  simulations could run at the same time.
- Line 40 specifies a different simulation period (5 years) to the *Full simulation* set
  of simulations. All other parameters set in the *Full simulation* set carry
  through to this simulation set.

There are more examples in the simulation directory.

##################
Input file formats
##################

*************
Configuration
*************

.. _dataset-format:

********
Datasets
********

******
Agents
******

###################
Output file formats
###################

***************
Results reports
***************

******
Agents
******


.. _parameter-ref:

##########
Parameters
##########

To do


.. _event-ref:

######
Events
######

To do

#################
Extending FastSTI
#################

To do (Example: Syphilis simulation)

####################
Help improve FastSTI
####################

We appreciate help with FastSTI, both with coding and documentation. Here are
some things that need to be done:

- Built-in calibration: At present if you want to calibrate a FastSTI model,
  you'd best use R or Python to process agent output files from FastSTI, and generate .ini
  configuration files as input back into FastSTI with new parameters. We think
  it would probably be better if FastSTI's configuration could be enhanced to
  calibrate the model.

- Concurrent relationships: Although the fsti_agent data structure supports
  concurrent relationships, none of the events are currently designed to handle
  meaningfully concurrent relationships.

- More events: Code variations on the current events and new events.

- Build Python and R interfaces to FastSTI.

- Improve this documentation.

Feel free to clone the Github repository and submit patches. But before doing
so, it may be best to email nathangeffen@gmail.com to inform us what you
would like to do, so we can discuss the best way to proceed.

#####################
Bugs and other issues
#####################

Please lodge bugs, requests for enhancements, etc at the FastSTI `Github
repository  issues page <https://github.com/nathangeffen/faststi/issues>`_.

#######
Credits
#######

- Nathan Geffen designed and implemented FastSTI.
- Stefan Scholz coded the syphilis model with Nathan.
- Eduard Grebe wrote the macOS installation instructions.

.. toctree::
   :maxdepth: 2
   :caption: Contents:


.. Indices and tables
.. ==================

.. * :ref:`genindex`
.. * :ref:`search`
